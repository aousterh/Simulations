package datarecorders.scramRecorder;

import java.awt.Color;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintStream;
import java.util.Iterator;
import java.util.Vector;

import utils.TraceFileCompressor;

import datarecorders.DataRecorder;

import math.Point2d;
import models.Model;
import models.Node;

import engine.Scenario;
import engine.SimTime;

public class ScramRecorder extends DataRecorder
 {
  private Vector nodes;
  private SimTime simTime;
  private String outputFilePath;
  
  private PrintStream ps;
  private File outXmlFile;
  private FileOutputStream fos;
  private boolean compressOutput;
  
  Vector lasts;
   
  public ScramRecorder()
   {
    nodes=new Vector();	 
    ps=null;
    outXmlFile=null;
	  fos=null;
	  outputFilePath="."+File.separator+"scramRecorderOutput.xml";
	  compressOutput=false;
	  lasts=new Vector();
   }//end constructor
  
  public void setOutputFilePath(String outputFileName)
   { this.outputFilePath=outputFileName; }
  
  public void setCompressOutput(boolean compressOutput)
   { this.compressOutput=compressOutput; }
   
  public void setup(Vector models, Scenario scenario, SimTime time) 
   {
	//create the list of nodes
	setupNodes(models);  
	
	//create the XML file to store data
	createXmlFile(time);
	
	//write static info to the XML file
	writeStaticInfo(time,scenario);
	
	//get a reference to time
	this.simTime=time;	
   }//end setup
  
 private void setupNodes(Vector models)
  {
   Iterator i=models.iterator();
	while(i.hasNext())
	 {
	  //Pull the nodes from the model
	  Model nextModel=(Model)i.next();
	  nodes.addAll(nextModel.getNodes());
     
	  //set up the last info
	  setupLastInfo(nextModel.getNodes().size());
	 }	
  }//end setupNodes
 
 private void setupLastInfo(int num)
  {
   for(int i=0;i<num;i++)
	lasts.add(new LastInfo());
  }//end setupLastInfo
 
 private void createXmlFile(SimTime time)
  {
   //create the XML file to save the simulation
   try{
	   fos=new FileOutputStream(outputFilePath);
	   ps=new PrintStream(fos);
	  } 
	 catch (IOException e) 
	  { e.printStackTrace(); }
  }//end createXmlFile	    
 
 private void writeStaticInfo(SimTime simTime, Scenario scenario) 
  {
   //Write preamble to XML file
	ps.println("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>");
	ps.println("<TraceInfo>\n");
	   
	//Write info on scenario
	ps.println(scenario.toXml());
	
   //Write basic node info
   writeBaseNode();	
   
  }//end writeStaticInfo 
  
 private void writeBaseNode() 
  {
   //Write the opening tag 
   ps.println(" <Nodes num=\""+nodes.size()+"\">");
    
   //Write node info
   Iterator i=nodes.iterator();
   while(i.hasNext())
    {
	 Node nextNode=(Node)i.next();
	 ps.println("  <Node radius=\""+nextNode.getRadius()+"\"/>");
    } 
   
   //Write the closing tag
   ps.println(" </Nodes>");
  }//end writeBaseNodeInfo

public void record(SimTime time) 
   {
	//Write the tag of time
	ps.println(" <Time t=\""+time.getTime()+"\" loop=\""+simTime.getLoop()+"\">");	 
    
	//Write the node info
	writeNodeInfo();
	
	//Write closing tag
	ps.println(" </Time>\n");
   }//end record

private void writeNodeInfo() 
 {
  for(int i=0;i<nodes.size();i++)
   {
	Node nextNode=(Node)nodes.elementAt(i); 	
	 
	Point2d pos=nextNode.getPosition();
	Color rgb=nextNode.getColor();
	 
	//Write the position in the file
	ps.print("  <NT x=\""+pos.x+"\" y=\""+pos.y+"\"");
	
	LastInfo lastInfo=(LastInfo)lasts.elementAt(i);
	
  
     
     
	if(lastInfo.cfrAndSwap(nextNode.getAntennaRadius()))
	 {ps.print(" ar=\""+nextNode.getAntennaRadius()+"\"");}
	
	
	if(lastInfo.cfrAndSwap(nextNode.getColor()))
	 {
	  ps.print(" r=\""+rgb.getRed()+
			   "\" g=\""+rgb.getGreen()+
			   "\" b=\""+rgb.getBlue()+"\"");
	 }
	
	ps.print("/>\n");
   }		 
}//end writeNodeInfo

  public void close()
   {
    //Write the time info
	ps.println(simTime.dynamicTimetoXml()); 
	 
    //Close the root tags
	ps.println("</TraceInfo>");
	
	//Close the XML file
	try
	 {fos.close();} 
	catch (IOException e) 
	   {e.printStackTrace();}  
	
	//Compress the file
	if(compressOutput==true)
	{	
	 File normalFile=new File(outputFilePath); 
	 if(normalFile.exists())
	  {	 
	   File compressedFile=new File(outputFilePath+".gz");
	   boolean res=TraceFileCompressor.compress(normalFile,compressedFile);
	   if(res==true)
		 normalFile.delete();  
	  }
	 
	} 
  }//end close	
 }//end Class ScramRecorder


class LastInfo
 {
  private float ar;
  private Color color;
  
  public LastInfo()
   {
	this.ar=-1;
	this.color=null; 
   }//end constructor
  
 public float getAR()
  {return ar;} 
 
 public Color getColor()
  {return color;} 
 
 public boolean cfrAndSwap(float nowAr)
  {
   if(ar==-1)
    {
	 ar=nowAr;
	 return true;
    }  
	 
   if(ar==nowAr)
   { return false;}
  else
   {
	ar=nowAr;
	return true;
   }
  }//end cfrAndSwap 
 
 public boolean cfrAndSwap(Color nowCol)
  {
   if(color==null)
	{
	 color=nowCol;
	 return true;
	}  	 
	 
   if(color==nowCol)
    { return false;}
   else
    {
	 color=nowCol;
	 return true;
    }
 }//end cfrAndSwap 
 
}//end LastInfo
